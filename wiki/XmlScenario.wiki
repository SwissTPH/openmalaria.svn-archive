#summary Editing scenario descriptions

= Introduction =

The main input to the simulator is an [http://www.w3schools.com/xml/default.asp XML] file generally called `scenario.xml` (though it may be named something different if the `--scenario FILE` command-line option is passed to openmalaria). This has several sections, described here.   The file contents are described in a more technical (and probably more complete) way by the [http://www.w3schools.com/schema/default.asp XSD] schema [http://code.google.com/p/openmalaria/source/browse/trunk/model/scenario.xsd file].

== Scope of documentation ==

This documentation is intended to aid individuals editing scenario files, either by hand or with the scenario editor currently under development, by serving as a rough reference manual. It omits several details, which may be covered by the editor, but for use by hand it is recommended to refer to existing scenarios as guides.

== Contents ==

<wiki:toc max_depth="3" />

= Scenario element: `scenario` =

The primary element in the file is called "scenario" (this encapsulates everything else in the file, except the XML header line).

It has the following attributes:

|| attribute         || data type || purpose                                         ||
|| schemaVersion     || int       || Version of XSD schema to use; should correspond to one of the `scenario_VER.xsd` files in [http://code.google.com/p/openmalaria/source/browse/#svn/trunk/test test] ||
|| analysisNo        || int       ||                                                 ||
|| name              || string    || user-friendly name for the scenario             ||
|| wuID              || int       || BOINC workunit number (automatically set when needed) ||
|| assimMode         || 0 or 1    || removes 3 columns from output.txt for BOINC usage (use 0 for local scenarios) ||

== Demography element: `demography` ==

Describes the population size and age structure. Most of our scenarios use the same age-structure data from Ifakara, Tanzania. Adjusting the population size is useful, since it has a major impact on run-time and stochasticity of results (1000-100000 individuals are often used in experiments; testing scenarios often use less).

== Monitoring element: `monitoring` ==

The `monitoring` element is used to describe two types of output: continuous (or at least regular) reporting of single values, and survey data, which may be irregular and is usually sub-divided by age-group or another differentiator.

=== Measures: `continuous`, `SurveyOptions` ===

The `continuous` and `SurveyOptions` elements describe which outputs to enable for the two outputs, using a list of sub-elements of the form `<option name="NAME" value="true"/>`; lists of valid options are below.

[XmlMonitoring Tables of continuous and survey measures.]

=== Continuous reporting: `continuous` ===

Continuous reporting, when enabled (a `continuous` element is described and `period` is positive), outputs data every `period` days (`period` is an attribute of the `continuous` element).

This output normally starts from the beginning of the intervention period, but for diagnostic purposes it can be enabled from the beginning of initialization by including a `duringInit="true"` attribute. This has two additional side effects: an extra column, `simulation time`, is output as the first column, and where `period` is greater than the length of a timestep, reporting (during intervention period) may happen on different timesteps.

=== Surveys: `surveys`, `ageGroup` ===

The `surveys` element has a list of `surveyTime` sub-elements, each with the timestep of a survey, starting from 0, the start of the intervention period (numbers match timesteps at which interventions can be deployed).

The `ageGroup` element contains a list of `group` sub-elements, each of which has an `upperbound` attribute. These (and the `lowerbound` attribute of `ageGroup`) define the age-groups which reports are divided into. The age-group specified in output data is the index within these groups, ordered by age (youngest to oldest), with the first age-group having index `1`.

== Interventions: `interventions` ==

The `interventions` element is organized informally into three sections, first descriptions of interventions (without associating times), second continuous interventions, and third timed interventions.

=== Descriptions ===

Intervention descriptions are, at this time, all direct sub-elements of `interventions` and not some other element.

The `MDADescription` element is only required when using _Mass Drug Administration_ interventions on a one-day timestep. It can then take a `schedule` sub-element describing a treatment dose or schedule taken by individuals covered by the administration campaign. There are currently no adherence/dose size/quality effects varying this; i.e. individuals either are not covered by the campaign and receive nothing or are and receive the full schedule.

The `vaccineDescription` element describes vaccines.

The `iptiDescription` describes _Intermittent Preventive Treatment for Infants_ . One important point: including this element also enables the IPT drug/within-host model, which adds a protective effect to every treatment. (This behaviour could be changed in the future to use a separate model-option switch.)

The `anopheles` element, if used, should be listed for each mosquito species (using the `mosquito` attribute to associate with one of the mosquito species specified in entomological data). Each may contain descriptions for _Insecticide Treated Net_ (`ITNDescription`), _Indoor Residual Spraying_ (`IRSDescription`) and a mosquito repellant (`VADescription` — _Vector Availability_) intervention. Theses have sub-elements describing a parameter as a Weibull decay curve. All three have a `deterrency` parameter; additionally `ITNDescription` has `preprandialKillingEffect` and `postprandialKillingEffect` (chance of killing a mosquito before or after feeding) and `IRSDescription` has `killingEffect` (chance of killing mosquito while resting) parameters.

=== Continuous: `continuous` ===

Interventions with continuous deployment are described by a `continuous` element. This accepts sub-elements `vaccine`, `ITN` and `ipti` (see descriptions above); these may occur more than once. (They must be listed in order of type; that is all `vaccine` elements before any `ITN` elements, etc.)

Each of these has the same type: a `targetAgeYrs` attribute and a `coverage` attribute. Every individual has a probability (equal to `coverage`) of receiving this intervention when they reach age `targetAgeYrs` in years (need not be an integer).   

=== Timed: `timed` ===

Timed interventions correspond to mass deployment at a specific time point. The `timed` element accepts a list of `intervention` sub-elements, each of which describes interventions occuring at a time specified by its `time` attribute. The following interventions may occur (and should be listed in this order within each `intervention`):

|| `changeHS` || Replaces the current health-system description with a new one. Must be a complete description of the health system (contain an `ImmediateOutcomes` or `EventScheduler` element, and a `CFR` element, as with the usual `healthSystem` element) ||
|| `changeEIR` || Replaces EIR data with new, daily, data described here. Data must be sufficient to last until the end of the simulation. ||
|| `importedInfectionsPerThousandHosts` || Not an intervention, but deployed the same way: a floating-point number describing the chance each individual recieves an infection (hence number introduced is unlikely to be exactly the number specified) ||
|| `MDA` || Mass drug administration (clears infections directly for models with a 5-day timestep and administers drugs for models with a 1-day timestep) ||
|| `vaccinate` || Mass vaccination campaign ||
|| `ITN` || Mass ITN-deployment ||
|| `IRS` || IRS spray round ||
|| `VectorAvailability` || Mass mosquito-repellent deployment (e.g. house spraying) ||
|| `ipti` || Mass IPTi campaign ||
|| `larviciding` || Mosquito emergence-rate reduction intervention. Has an `anopheles` sub-element for each mosquito sub-species, containing the attributes: `mosquito` (name of sub-species), `effectiveness` (proportional reduction in mosquito emergence), `duration` (number of days the intervention is effective for). ||

The `MDA` through to `ipti` interventions above are all mass deployment. Each has its deployment described by the following attributes: `maxAge` and `minAge` describe the age-range applicable in years (optional; they default to 100 and 0 respectively), and `coverage` specifies the chance that each individual receives the intervention.

== Health system: `healthSystem` ==

Two independent health-system models have been implemented (see ModelClinical). The name "health system" may be a little misleading: the model also describes death and sequelae rates, even for patients not entering the formal health-system.

An element describing the appropriate one of these must be present, and an element describing case-fatality rate (CFR) data must be present.

=== 5-day timestep: `ImmediateOutcomes` ===

When the simulation uses a granularity of 5-day timesteps, fevers can be considered too occur entirely within one timestep, and thus it is reasonable to decide parasitological, clinical and cost outcomes within a single timestep — hence this model was named the clinical immediate outcome model.

First, the drugs used for `firstLine`, `secondLine` and `inpatient` treatment are defined in the `drugRegimen` element. Drug codes may be one of `CQ`, `SP`, `AQ`, `SPAQ`, `ACT`, `QN`, or `selfTreatment`.

Then, `compliance` (adherence rate), `initialACR` (initial cure-rate for compliers) and `nonCompliersEffective` (effective cure-rate for non-compliers) are specified per drug (must be described for self-treatment but optional for other drugs; values default to 0).

Additionally, the following (fairly self-explanetory) elements must be described: `pSeekOfficialCareUncomplicated1`, `pSelfTreatUncomplicated`, `pSeekOfficialCareUncomplicated2`, `pSeekOfficialCareSevere`, and `pSequelaeInpatient`.

=== 1-day timestep: `EventScheduler` ==

The event-scheduler model encapsulates a case-management model and schedules sickness events (fever start/end, recovery/death outcomes).

==== Case management: `uncomplicated` and `complicated` ====

The case-management part consists of decision trees and treatment schedules, split into two cases: `uncomplicated` for non-malarial and malarial fevers not requiring hospitalisation, and `complicated` for severe malarial fevers or those worsened through a further insult. Apart from a few decision rules, the `uncomplicated` and `complicated` elements have the same format: a `decisions` element and a `treatments` element.

===== `decisions` =====

The `decisions` element describes a model of treatment-seeking and health-system decisions, using a list of `decision` sub-elements.

A decision is described by:
 * a name (an identifier of alpha-numeric characters plus `.` and `_`)
 * a list of possible outcomes (decision outcomes are often referred to using the format `NAME(OUTCOME)`)
 * a list of other decisions this decision depends upon in order to be determined
 * some description of how an outcome is derived

A few built-in decisions exist, and a few particular decisions must be provided, but otherwise the number of decisions used and potential names are not fixed. The built-in and required decisions are:

| name | outcomes | | description |
| `case` | `UC1`, `UC2` | built-in, `uncomplicated` only | Case is second-line (`UC2`) if, within the [XmlScenario#clinical health-system memory], a fever occurred where anti-malarials were prescribed, otherwise the case is `UC1`. |
| `result` | `none`, `negative`, `positive` | built-in | If the `test` decision has an outcome other than `none`, a parasite-density test is performed using the current density of the simulated case; otherwise the outcome is `none`. The number of RDT tests used is reported for costing purposes. |
| `test` | `none`, `microscopy`, `RDT` | required | Determines whether and which type of malarial diagnostic is used |
| `treatment` | | required | Selects which treatment to medicate. Outcomes are not restricted, but must match exactly the treatments available (so probably a treatment called "none" will need to be added). |
| `hospitalisation` | `none`,`immediate`,`delayed` | required for `complicated` | Determines whether the individual goes to hospital or not, and whether a 1-day delay to hospital entry occurs. Hospitalisation affects fatality rate, reporting, and protects patient from mosquito bites. A delay causes the afore-mentioned effects to be delayed as expected, but does not delay treatments — this means that immediate suppositories may be given, but hospital-administered drugs should be delayed by a day. | 

Regarding costing, sometimes in severe cases 2 tests would be used (by a referring health centre, and by the hospital accepting the patient). One method of dealing with this, assuming the in-hospital test result has no impact on treatment decisions, is to assume all patients get an RDT test in hospital (by adding the number of hospital recoveries+deaths+sequelae to the number of RDTs reported), and use the `test` decision to describe whether an out-of-hospital test occurs.

Decisions described in the XML are all given as a `decision` element who's content is some form of tree; there are currently two varieties as in the table below. The syntax for a tree is:

<placeholder>

| age-dependent | The tree must have exactly one dependency: `age`. Branches should be identified with the syntax `age(a-b)` where a and b are in the range `[0,inf]` (allowing the special value `inf`). In a branch-set these ranges must not overlap and must cover the entire range `[0,inf]` (i.e. lowest bound must be `0` and highest `inf` with matching boundaries). Age ranges are considered half-open, open at the top (i.e. an age on a boundary matches the higher age-group). |
| stochastic | A generic decision whose outcomes are determined by input decisions and/or random samples. Unless purely deterministic, `p` must be used as in input dependency and then probability branches may be specified using `p(x)` where `x` is the probability of the branch being chosen. All probabilities in a branch-set must add up to 1. |

===== `treatments` =====

==== Severe-fever outcomes: `ClinicalOutcomes` ====

The `EventScheduler` element also has a `ClinicalOutcomes` element, describing:

| name | type | description |
| maxUCSeekingMemory | int | Maximum number of timesteps (including first of case) an individual will remember they are sick before resetting. |
| uncomplicatedCaseDuration | int | Fixed length of an uncomplicated case of malarial/non-malarial sickness (from treatment seeking until return to life-as-usual). Usually 3. |
|| complicatedCaseDuration | int | Fixed length of a complicated/severe case of malaria (from treatment seeking until return to life-as-usual). |
| complicatedRiskDuration | int | Number of days for which humans are at risk of death during a severe or complicated case of malaria. Cannot be greater than the duration of a complicated case or less than 1 day. |
| pImmediateUC | double | Probability that UC treatment seeking will be done immediately when sick, on second day given that it wasn't done on first, etc. |


=== Case-fatality per age: `CFR` ===

The data here describes the case-fatality rates of hospitalised cases receiving successful treatment per age-group (or rather, a CFR-per-age function is constructed using step-wise linear interpolation of the (lowerbound, cfr) pairs).

Since collecting fatality-rate data for cases outside of hospital, the "community death rate" (used for cases not receiving hospital care, or, in the `ImmediateOutcomes` model, ineffective treatment) is constructed from the hospital CFR data by multiplying the odds by a parameter (exp of the LOG_ODDS_RATIO_CF_COMMUNITY parameter).

In practice, we always use the same data-set here.

== Entomological data: `entoData` ==

Entomological data are described by the `entoData` element — this can have either a `vector` or a `nonVector` sub-element (which determines which transmission model to use as well as providing data).

The `entoData` element also has two attributes: `name` (just a user-friendly name), and `mode`. The `mode` parameter determines which transmission mode to enter at the start of the intervention period: 2 to enforce fixed EIR or 4 to allow dynamic simulations where human infectiousness has a feed-back effect on EIR (the usual choice). (For more info on `mode`, see `enum SimulationMode` in [http://code.google.com/p/openmalaria/source/browse/trunk/include/Transmission/TransmissionModel.h TransmissionModel.h].)

=== Vector parameters: `vector` ===

[XmlEntoVector Vector-model parameter description.]

=== Non-vector parameters: `nonVector` ===

The `nonVector` element primarily consists of a list of daily EIR (_Entomological Inoculation Rate_) parameters (`EIRDaily` elements). These specify the EIR per day of the year for the pre-intervention equilibrium state. Where data for more than one year are provided, they are simply averaged for each day of the year.

`nonVector` also has an `eipDuration` attribute: the _extrinsic incubation period_ (sporozoite development time, in days), which determines the delay before changes in human infectiousness affect the EIR (in dynamic mode only).

== Drug parameters: `drug` ==

This describes PK and PD parameters of drugs. In the future initial levels of resistance need to be described (in fact, these are to some extent now, but the schema for entering this data may change). For now, just copy this section from another scenario which describes the desired drugs.

== Model parameters: `model` ==

Finally, `scenario` contains a `model` element, grouping some of the data describing the "model" together.

=== `ModelOptions` ===

The `ModelOptions` sub-element is a list of binary options, in the same format as `SurveyOptions` (except here, bug-fix options default to true if not specified, while the rest still default to false). The available options are:

<placeholder>

(For now, see [http://code.google.com/p/openmalaria/source/browse/trunk/include/util/ModelOptions.hpp ModelOptions.hpp].)

=== `clinical` ===

The `clinical` element currently simply has a `healthSystemMemory` attribute: if, when a sickness event occurs, the previous episode was less than this many time-steps ago, the new episode is considered a second case (second-line treatment may be used and the two episodes will likely be reported as a single episode).

(The main health-system description is [XmlScenario#Health_system above].)

=== `parameters` ===

The `parameters` element describes a list of parameters which are fitted. Usually, one can just copy this section from an _appropriate_ scenario. Varying the length of the timestep or changing several of the model's options will affect the ideal values of these parameters. Ideally we should make a list of all fit parameter sets, together with the conditions under which they are valid, publically available somewhere.

A list of which parameters may be specified can be found here: [http://code.google.com/p/openmalaria/source/browse/trunk/include/inputData.h inputData.h] (the numbers, rather than names, are used to specify each parameter in scenario files).

This element also contains some attributes (placed _here_ for historical reasons):

 *  `interval` — number of days in a time-step
 *  `iseed` — number to seed random-number-generator with
 *  `delta` — unused and removed in schema version 19
 *  `latentp` — number of timesteps by which blood-stage infection is delayed from biting