#summary Design of scenarios and XML configuration

= Design of scenario configuration =

OpenMalaria is designed to run small-medium scale independent simulations. If you want to design an experiment evaluating the impact of one of more factors, you may want to read about [ExperimentDesign designing experiments].

The following is intended as an easy to read and use guide to creating scenarios. For a curter reference guide, see [XmlScenario].

Within a simulation of a single setting, dubbed a _scenario_, there are a number of choices to make, outlined below. These choices are entered as XML elements. Removing much of the detail, such an XML file looks like this:

{{{
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<scenario xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" analysisNo="0"
    assimMode="0" name="template scenario" schemaVersion="25" wuID="0"
    xsi:noNamespaceSchemaLocation="scenario_25.xsd">
  <demography ...>
    ...
  </demography>
  <monitoring name="Quarterly Surveys">
    ...
  </monitoring>
  <interventions name="Full Set">
    ...
  </interventions>
  <healthSystem>
    ...
  </healthSystem>
  <entoData ...>
    ...
  </entoData>
  <drugDescription>
    ...
  </drugDescription>
  <model>
    <ModelOptions>
      ...
    </ModelOptions>
    <clinical healthSystemMemory="6"/>
    <human>
      ...
    </human>
    <parameters interval="5" iseed="0" latentp="3">
      ...
    </parameters>
  </model>
</scenario>
}}}

This may be used as a template, adapting if necessary to the latest schema version.

== Model ==

The first decision to make is which models to use. You may have noticed above that the `parameters` element has an `interval="5"` attribute; this specifies the length (in days) of the fundamental time-step of the simulator. Some models work on a 5-day time-step, and some on a 1-day time-step (which has extra capabilities but results in a more complex and slower model). Note that several other parts of the configuration are entered using units of the length of a time-step.

The main choices to make with regards to the model to use is the [ModelWithinHost#Asexual_infection_models within-host / infection model]:
  * "Descriptive" model: 5-day time-step; several parameterizations have been fit for this model
  * "Empirical" model: 1-day time-step; currently has not been parameterized
  * Molineaux model: 1-day time-step; parameter fitting is currently in progress

This will also determine which [ModelClinical clinical / health system model] may be used:
  * 5-day timestep model with simple cure/fail response to treatment and immediately determined clinical outcome
  * 1-day timestep model: treatments use full PKPD modelling with a daily effect on parasite densities; clinical outcome determined by both the parasite density and clinical decisions

After selecting the within-host model to use, an appropriate `<model>...</model>` element should be copied. Note that while the sub-elements of `model` (in particular `ModelOptions`) _can_ be changed, in theory they have an effect on the optimal paramerization(s), so changing them would result in an invalid model.

As of schema version 24, some further data is included within the `model` element:
{{{
<human>
  <availabilityToMosquitoes>
    <group lowerbound="0.0" value="0.225940909648"/>
    <group lowerbound="1.0" value="0.286173633441"/>
    <group lowerbound="2.0" value="0.336898395722"/>
    <group lowerbound="3.0" value="0.370989854675"/>
    <group lowerbound="4.0" value="0.403114915112"/>
    <group lowerbound="5.0" value="0.442585112522"/>
    <group lowerbound="6.0" value="0.473839351511"/>
    <group lowerbound="7.0" value="0.512630464378"/>
    <group lowerbound="8.0" value="0.54487872702"/>
    <group lowerbound="9.0" value="0.581527755812"/>
    <group lowerbound="10.0" value="0.630257580698"/>
    <group lowerbound="11.0" value="0.663063362714"/>
    <group lowerbound="12.0" value="0.702417432755"/>
    <group lowerbound="13.0" value="0.734605377277"/>
    <group lowerbound="14.0" value="0.788908765653"/>
    <group lowerbound="15.0" value="0.839587932303"/>
    <group lowerbound="20.0" value="1.0"/>
    <group lowerbound="20.0" value="1.0"/>
  </availabilityToMosquitoes>
  <weight multStdDev="0.14">
    <group lowerbound="0.0" value="13.9856718"/>
    <group lowerbound="1.0" value="18.30372108"/>
    <group lowerbound="2.0" value="21.745749"/>
    <group lowerbound="3.0" value="24.25753512"/>
    <group lowerbound="4.0" value="26.06595444"/>
    <group lowerbound="5.0" value="28.48868784"/>
    <group lowerbound="6.0" value="30.84202788"/>
    <group lowerbound="7.0" value="33.48638244"/>
    <group lowerbound="8.0" value="35.20335432"/>
    <group lowerbound="9.0" value="37.19394024"/>
    <group lowerbound="10.0" value="40.1368962"/>
    <group lowerbound="11.0" value="42.00539916"/>
    <group lowerbound="12.0" value="44.53731348"/>
    <group lowerbound="13.0" value="46.77769728"/>
    <group lowerbound="14.0" value="49.48396092"/>
    <group lowerbound="15.0" value="54.36"/>
    <group lowerbound="20.0" value="60.0"/>
    <group lowerbound="20.0" value="60.0"/>
  </weight>
</human>
}}}
The `weight` data is only required for 1-day timestep models; the `availabilityToMosquitoes` data is needed for all models. Graphs of the availability and weight data with interpolations (linear interpolations, shown by the blue lines, are enabled by default):

<wiki:comment>
Graphs generated with the `trunk/unittest/AgeGroupInterpolationSuite.py` script.
</wiki:comment>
http://openmalaria.googlecode.com/svn/wiki/graphs/human_avail_and_mass_age.png


TODO: add some parameterizations

The `drugDescription` element is only required when a 1-day time-step is used, and is essentially a library of parameters for the drug model. It should therefore not need to be edited (just copied from a source).

== Health system ==

[ScenarioHealthSystem Health system configuration.] 2 models are available, depending on the length of time-step used ([ModelClinical descriptions]).

== Transmission model ==

[ScenarioTransmission Transmission model configuration.] Two transmission models are available, independent of the length of the time-step ([ModelTransmission descriptions]):
  * direct input of transmission intensity with (optional) response to human infectiousness
  * model of the transmission vector (_anopheles_ mosquito)'s feeding cycle; allows modelling of vector stage interventions

== Demography ==

OpenMalaria uses a simple [ModelDemography demography model], enforcing a particular age distribution. Our standard set of demography data comes from Ifakara, Tanzania:

{{{
  <demography maximumAgeYrs="90" name="Ifakara" popSize="1000">
    <ageGroup lowerbound="0.0">
      <group poppercent="3.474714994" upperbound="1"/>
      <group poppercent="12.76004028" upperbound="5"/>
      <group poppercent="14.52151394" upperbound="10"/>
      <group poppercent="12.75565434" upperbound="15"/>
      <group poppercent="10.83632374" upperbound="20"/>
      <group poppercent="8.393312454" upperbound="25"/>
      <group poppercent="7.001421452" upperbound="30"/>
      <group poppercent="5.800587654" upperbound="35"/>
      <group poppercent="5.102136612" upperbound="40"/>
      <group poppercent="4.182561874" upperbound="45"/>
      <group poppercent="3.339409351" upperbound="50"/>
      <group poppercent="2.986112356" upperbound="55"/>
      <group poppercent="2.555766582" upperbound="60"/>
      <group poppercent="2.332763433" upperbound="65"/>
      <group poppercent="1.77400255" upperbound="70"/>
      <group poppercent="1.008525491" upperbound="75"/>
      <group poppercent="0.74167341" upperbound="80"/>
      <group poppercent="0.271863401" upperbound="85"/>
      <group poppercent="0.161614642" upperbound="90"/>
    </ageGroup>
  </demography>
}}}

The only aspect of this we commonly change is the population size. Population sizes below around 1000 humans tend to have large amounts of stochastic noise (although this is still clearly noticeable with 1000 humans, particularly in low-frequency outputs such as deaths resulting from malaria). Large numbers increase computation time and RAM usage; as a rough guide 100,000 individuals when using a 5-day time-step or 10,000 individuals when using a 1-day time-step should require somewhere (very roughly, depending on machine performance) in the region of two hours computation.

== Interventions ==

See [ModelInterventions this page].

== Monitoring ==

When designing a scenario, you will need to think about what kind of output is required. See [Monitoring] and the [XmlMonitoring list of available measures].

== Drug library ==

Scenarios running on a 1-day timestep require PK and PD parameters for each drug used, for example:
{{{
<drugDescription>
  <drug abbrev="AR">
    <PD>
      <allele name="sensitive">
        <initial_frequency>1</initial_frequency>
        <max_killing_rate>4</max_killing_rate>
        <IC50>0.0023</IC50>
        <slope>4</slope>
      </allele>
    </PD>
    <PK>
      <negligible_concentration>0.000023</negligible_concentration>
      <half_life>0.175</half_life>
      <vol_dist>17.4</vol_dist>
    </PK>
  </drug>
  <drug abbrev="XX" ...
</drugDescription>
}}}

Our collaborators at the Liverpool School of Tropical Medicine are developing a library of drug parameters; one can copy their `drugDescription` element from [http://code.google.com/p/openmalaria/source/browse/trunk/test/valerieCM/scenarioBase.xml?r=1545 this XML file] (near the end).